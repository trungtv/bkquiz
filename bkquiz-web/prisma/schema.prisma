generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refreshToken      String? @map("refresh_token")
  accessToken       String? @map("access_token")
  expiresAt         Int?    @map("expires_at")
  tokenType         String? @map("token_type")
  scope             String?
  idToken           String? @map("id_token")
  sessionState      String? @map("session_state")
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Answer {
  attemptId         String
  sessionQuestionId String
  selected          Json                    @default("[]")
  submittedAt       DateTime? // When this answer was submitted (per-question submit)
  updatedAt         DateTime                @updatedAt
  attempt           Attempt                 @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  sessionQuestion   SessionQuestionSnapshot @relation(fields: [sessionQuestionId], references: [id], onDelete: Cascade)

  @@id([attemptId, sessionQuestionId])
  @@index([attemptId])
}

model Attempt {
  id               String            @id @default(cuid())
  sessionId        String
  userId           String
  status           AttemptStatus     @default(active)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime
  attemptStartedAt DateTime? // Thời điểm student thực sự bắt đầu làm bài
  nextDueAt        DateTime?
  lastVerifiedAt   DateTime?
  failedCount      Int               @default(0)
  cooldownUntil    DateTime?
  lockedUntil      DateTime?
  submittedAt      DateTime?
  score            Float?
  questionScores   Json? // Cache điểm từng câu { questionId: score }
  answers          Answer[]
  quizSession      QuizSession       @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  attemptQuestions AttemptQuestion[]
  checkpointLogs   CheckpointLog[]

  @@unique([sessionId, userId])
  @@index([sessionId])
  @@index([userId])
}

model AttemptQuestion {
  attemptId         String
  sessionQuestionId String
  order             Int
  attempt           Attempt                 @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  sessionQuestion   SessionQuestionSnapshot @relation(fields: [sessionQuestionId], references: [id], onDelete: Cascade)

  @@id([attemptId, sessionQuestionId])
  @@unique([attemptId, order])
  @@index([attemptId])
}

model CheckpointLog {
  id           String              @id @default(cuid())
  attemptId    String
  type         CheckpointEventType
  dueAt        DateTime?
  ok           Boolean?
  enteredToken String?
  createdAt    DateTime            @default(now())
  attempt      Attempt             @relation(fields: [attemptId], references: [id], onDelete: Cascade)

  @@index([attemptId, createdAt])
}

model ClassMembership {
  classroomId String
  userId      String
  roleInClass ClassroomRole    @default(student)
  status      MembershipStatus @default(active)
  joinedAt    DateTime         @default(now())
  classroom   Classroom        @relation(fields: [classroomId], references: [id], onDelete: Cascade)
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([classroomId, userId])
  @@index([classroomId])
  @@index([userId])
}

model Classroom {
  id             String            @id
  name           String
  classCode      String            @unique
  ownerTeacherId String
  createdAt      DateTime          @default(now())
  updatedAt      DateTime
  memberships    ClassMembership[]
  ownerTeacher   User              @relation(fields: [ownerTeacherId], references: [id])
  sessions       QuizSession[]
  tags           ClassroomTag[]
}

model Option {
  id         String    @id
  questionId String
  content    String
  isCorrect  Boolean   @default(false)
  order      Int       @default(0)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime
  deletedAt  DateTime?
  question   Question  @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId])
}

model Question {
  id                 String        @id
  poolId             String
  type               QuestionType
  prompt             String
  createdByTeacherId String
  createdAt          DateTime      @default(now())
  updatedAt          DateTime
  deletedAt          DateTime?
  options            Option[]
  createdBy          User          @relation(fields: [createdByTeacherId], references: [id])
  pool               QuestionPool  @relation(fields: [poolId], references: [id], onDelete: Cascade)
  tags               QuestionTag[]

  @@index([deletedAt])
  @@index([poolId])
}

model QuestionPool {
  id             String              @id
  name           String
  visibility     PoolVisibility      @default(private)
  ownerTeacherId String
  createdAt      DateTime            @default(now())
  updatedAt      DateTime
  questions      Question[]
  owner          User                @relation(fields: [ownerTeacherId], references: [id])
  shares         QuestionPoolShare[]
  tags           QuestionPoolTag[]

  @@index([ownerTeacherId])
}

model QuestionPoolShare {
  poolId              String
  sharedWithTeacherId String
  permission          PoolSharePermission
  createdAt           DateTime            @default(now())
  pool                QuestionPool        @relation(fields: [poolId], references: [id], onDelete: Cascade)
  sharedWith          User                @relation(fields: [sharedWithTeacherId], references: [id], onDelete: Cascade)

  @@id([poolId, sharedWithTeacherId])
  @@index([sharedWithTeacherId])
}

model QuestionTag {
  questionId String
  tagId      String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  tag        Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([questionId, tagId])
  @@index([tagId, questionId])
}

model ClassroomTag {
  classroomId String
  tagId       String
  createdAt   DateTime  @default(now())
  classroom   Classroom @relation(fields: [classroomId], references: [id], onDelete: Cascade)
  tag         Tag       @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([classroomId, tagId])
  @@index([tagId, classroomId])
}

model QuizTag {
  quizId    String
  tagId     String
  createdAt DateTime @default(now())
  quiz      Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([quizId, tagId])
  @@index([tagId, quizId])
}

model QuestionPoolTag {
  poolId    String
  tagId     String
  createdAt DateTime     @default(now())
  pool      QuestionPool @relation(fields: [poolId], references: [id], onDelete: Cascade)
  tag       Tag          @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([poolId, tagId])
  @@index([tagId, poolId])
}

model Quiz {
  id                 String        @id @default(cuid())
  title              String
  createdByTeacherId String
  settings           Json          @default("{}")
  status             QuizStatus    @default(draft)
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  createdBy          User          @relation(fields: [createdByTeacherId], references: [id])
  rules              QuizRule[]
  sessions           QuizSession[]
  tags               QuizTag[]

  @@index([createdByTeacherId])
}

model QuizRule {
  id           String   @id @default(cuid())
  quizId       String
  tagId        String
  count        Int?
  commonCount  Int?
  variantCount Int?
  extraPercent Float?
  filters      Json     @default("{}")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  quiz         Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  tag          Tag      @relation(fields: [tagId], references: [id])

  @@index([quizId])
  @@index([tagId])
}

model QuizSession {
  id                String                    @id @default(cuid())
  quizId            String
  status            QuizSessionStatus         @default(lobby)
  startedAt         DateTime?
  endedAt           DateTime?
  totpSecret        String
  totpStepSeconds   Int                       @default(45)
  settings          Json? // Store session-specific settings like durationSeconds
  createdAt         DateTime                  @default(now())
  updatedAt         DateTime                  @updatedAt
  classroomId       String
  attempts          Attempt[]
  classroom         Classroom                 @relation(fields: [classroomId], references: [id], onDelete: Cascade)
  quiz              Quiz                      @relation(fields: [quizId], references: [id], onDelete: Cascade)
  commonQuestions   SessionCommonQuestion[]
  questionSnapshots SessionQuestionSnapshot[]

  @@index([classroomId])
  @@index([quizId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model SessionCommonQuestion {
  sessionId         String
  tagId             String
  sessionQuestionId String
  order             Int
  session           QuizSession             @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sessionQuestion   SessionQuestionSnapshot @relation(fields: [sessionQuestionId], references: [id], onDelete: Cascade)
  tag               Tag                     @relation(fields: [tagId], references: [id])

  @@id([sessionId, tagId, sessionQuestionId])
  @@unique([sessionId, tagId, order])
  @@index([sessionId, tagId])
}

model SessionOptionSnapshot {
  id                String                  @id @default(cuid())
  sessionQuestionId String
  order             Int
  content           String
  isCorrect         Boolean                 @default(false)
  sessionQuestion   SessionQuestionSnapshot @relation(fields: [sessionQuestionId], references: [id], onDelete: Cascade)

  @@unique([sessionQuestionId, order])
}

model SessionQuestionSnapshot {
  id               String                  @id @default(cuid())
  sessionId        String
  sourceQuestionId String
  tagId            String?
  type             QuestionType
  prompt           String
  order            Int
  createdAt        DateTime                @default(now())
  answers          Answer[]
  attemptQuestions AttemptQuestion[]
  commonQuestions  SessionCommonQuestion[]
  options          SessionOptionSnapshot[]
  session          QuizSession             @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  tag              Tag?                    @relation(fields: [tagId], references: [id], onDelete: Restrict)

  @@unique([sessionId, order])
  @@index([sessionId])
  @@index([sessionId, tagId])
}

model Tag {
  id                       String                    @id @default(cuid())
  name                     String
  normalizedName           String                    @unique
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  questionTags             QuestionTag[]
  quizRules                QuizRule[]
  sessionCommonQuestions   SessionCommonQuestion[]
  sessionQuestionSnapshots SessionQuestionSnapshot[]
  classroomTags            ClassroomTag[]
  quizTags                 QuizTag[]
  poolTags                 QuestionPoolTag[]
}

model User {
  id            String              @id @default(cuid())
  name          String?
  email         String?             @unique
  emailVerified DateTime?
  image         String?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  accounts      Account[]
  attempts      Attempt[]
  memberships   ClassMembership[]
  ownedClassrooms Classroom[]
  questions     Question[]
  questionPools QuestionPool[]
  poolShares    QuestionPoolShare[]
  quizzes       Quiz[]
  sessions      Session[]
  roles         UserRole[]
}

model UserRole {
  userId String
  role   SystemRole
  user   User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, role])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum AttemptStatus {
  active
  submitted
  locked
}

enum CheckpointEventType {
  scheduled
  verify_ok
  verify_fail
  locked
}

enum ClassroomRole {
  student
  ta
  teacher
}

enum MembershipStatus {
  active
  left
  banned
}

enum PoolSharePermission {
  view
  use
  edit
}

enum PoolVisibility {
  private
  shared
}

enum QuestionType {
  mcq_single
  mcq_multi
}

enum QuizSessionStatus {
  lobby
  active
  ended
}

enum QuizStatus {
  draft
  published
  archived
}

enum ScoringMode {
  all_or_nothing
  partial
  penalty
}

enum SystemRole {
  teacher
  student
}
